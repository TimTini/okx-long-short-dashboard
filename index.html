<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>OKX Ratio Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Vanilla-DataTables -->
    <link href="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.css"
        rel="stylesheet">

    <style>
        body {
            padding: 20px;
        }

        table.dataTable-table {
            color: white;
        }

        #noDataMessage {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #ccc;
        }
    </style>
    <style>
        .column-toggle-menu {
            padding: 8px;
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .column-toggle-menu .dropdown-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-toggle-menu .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .column-toggle-menu .form-check {
            padding-left: 0;
            margin-bottom: 0;
        }

        .column-toggle-menu .form-check-input {
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">üìä OKX t·ªâ l·ªá Long/Short (C·∫≠p nh·∫≠t m·ªói 15 ph√∫t)</h2>
        <div class="mb-3">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="columnToggleButton"
                    data-bs-toggle="dropdown">
                    ·∫®n/Hi·ªán C·ªôt
                </button>
                <ul class="dropdown-menu column-toggle-menu" id="columnToggleMenu">
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="showAllColumns">
                            <i class="bi bi-eye"></i> Hi·ªán t·∫•t c·∫£
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="hideAllColumns">
                            <i class="bi bi-eye-slash"></i> ·∫®n t·∫•t c·∫£
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div id="noDataMessage" style="display: none;">
            ‚è≥ D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω, vui l√≤ng quay l·∫°i sau.
        </div>
        <div class="table-responsive">
            <table id="ratioTable" class="table table-dark table-bordered table-hover table-striped"
                style="display: none;">
                <thead>
                    <tr>
                        <th class="text-nowrap">C·∫∑p giao d·ªãch</th>
                        <th class="text-nowrap">Update At</th>
                        <th class="text-nowrap">Long %</th>
                        <th class="text-nowrap">Short %</th>
                        <th class="text-nowrap">Funding %</th>
                        <th class="text-nowrap">Vol 24h</th>
                        <th class="text-nowrap">Cap</th>
                        <th class="text-nowrap">Vol/Cap %</th>
                        <th class="text-nowrap">15m %</th>
                        <th class="text-nowrap">1h %</th>
                        <th class="text-nowrap">4h %</th>
                        <th class="text-nowrap">Xu H∆∞·ªõng</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.js"></script>
    <script>

        const columnDefinitions = [
            { name: 'C·∫∑p giao d·ªãch', visible: true },
            { name: 'Update At', visible: true },
            { name: 'Long %', visible: true },
            { name: 'Short %', visible: true },
            { name: 'Funding %', visible: true },
            { name: 'Vol 24h', visible: true },
            { name: 'Cap', visible: true },
            { name: 'Vol/Cap %', visible: true },
            { name: '15m %', visible: true },
            { name: '1h %', visible: true },
            { name: '4h %', visible: true },
            { name: 'Xu H∆∞·ªõng', visible: true }
        ];

        // Load settings from localStorage
        function loadColumnSettings() {
            const savedSettings = localStorage.getItem('columnSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                columnDefinitions.forEach((col, index) => {
                    col.visible = settings[index] ?? true;
                });
            }
        }

        // Save settings to localStorage
        function saveColumnSettings() {
            const settings = columnDefinitions.map(col => col.visible);
            localStorage.setItem('columnSettings', JSON.stringify(settings));
        }

        function initializeColumnToggle() {
            loadColumnSettings();
            const menu = document.getElementById('columnToggleMenu');
            // L·∫•y reference ƒë·∫øn divider v√† c√°c n√∫t control
            const divider = menu.querySelector('.dropdown-divider').parentElement;

            columnDefinitions.forEach((col, index) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'dropdown-item';
                a.href = '#';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.checked = col.visible;

                const label = document.createTextNode(col.name);

                a.appendChild(checkbox);
                a.appendChild(label);
                li.appendChild(a);

                // Ch√®n c√°c item m·ªõi v√†o tr∆∞·ªõc divider
                menu.insertBefore(li, divider);

                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    checkbox.checked = !checkbox.checked;
                    toggleColumn(index, checkbox.checked);
                });
            });

            // X·ª≠ l√Ω n√∫t "Hi·ªán t·∫•t c·∫£"
            document.getElementById('showAllColumns').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Th√™m d√≤ng n√†y ƒë·ªÉ ngƒÉn popup ƒë√≥ng l·∫°i
                setAllColumns(true);
            });

            // X·ª≠ l√Ω n√∫t "·∫®n t·∫•t c·∫£"
            document.getElementById('hideAllColumns').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Th√™m d√≤ng n√†y ƒë·ªÉ ngƒÉn popup ƒë√≥ng l·∫°i
                setAllColumns(false);
            });

            // √Åp d·ª•ng tr·∫°ng th√°i ·∫©n/hi·ªán ban ƒë·∫ßu
            columnDefinitions.forEach((col, index) => {
                if (!col.visible) {
                    window.dataTable.columns().hide([index]);
                }
            });
        }

        function toggleColumn(columnIndex, show) {
            columnDefinitions[columnIndex].visible = show;
            if (window.dataTable) {
                window.dataTable.columns().hide([columnIndex]); // ·∫®n c·ªôt
                if (show) {
                    window.dataTable.columns().show([columnIndex]); // Hi·ªán c·ªôt
                }
            }
            saveColumnSettings();
        }

        function setAllColumns(show) {
            columnDefinitions.forEach((col, index) => {
                col.visible = show;
                if (window.dataTable) {
                    if (show) {
                        window.dataTable.columns().show([index]);
                    } else {
                        window.dataTable.columns().hide([index]);
                    }
                }
            });

            // Update checkboxes
            const checkboxes = document.querySelectorAll('#columnToggleMenu input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = show;
            });

            saveColumnSettings();
        }

    </script>
    <script>
        const baseUrl = 'https://tcn.io.vn';
        const apiUrl = baseUrl + '/api/instrument_ratios';

        function formatTimestamp(timestamp) {
            const d = new Date(timestamp);

            const pad = n => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}-${pad(d.getMonth() + 1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        async function loadData() {
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                const instrument_ratios = data.data;

                const table = document.getElementById("ratioTable");
                const message = document.getElementById("noDataMessage");
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";

                if (!instrument_ratios || instrument_ratios.length === 0) {
                    table.style.display = "none";
                    message.style.display = "block";
                    return;
                }

                message.style.display = "none";
                table.style.display = "table";

                for (const item of instrument_ratios) {

                    // Retrieve the 24-hour trade volume in USDT
                    const vol24_usdt = item?.market_future ? item.market_future?.turnOver24h ?? 0.0 : 0.0;

                    // Retrieve the market capitalization from either market_spot or coin_info
                    const cap = (item?.market_spot && item.market_spot?.marketCap)
                        ? item.market_spot?.marketCap
                        : (item?.coin_info && item.coin_info?.marketCap)
                            ? item.coin_info?.marketCap
                            : 0.0;

                    // Calculate the volume-to-capitalization ratio as a percentage
                    const volCapRatio = (vol24_usdt && cap && cap > 0)
                        ? ((vol24_usdt / cap) * 100).toFixed(2)
                        : "0.0";

                    // Format the 24-hour trade volume in USDT for display
                    const format_vol24h_usdt = item?.market_future
                        ? item.market_future.format?.turnOver24h ?? ""
                        : "";

                    // Format the market capitalization for display
                    const format_mktcap = (item?.market_spot && item.market_spot.format?.marketCap)
                        ? item.market_spot.format?.marketCap
                        : (item?.coin_info && item.coin_info.format?.marketCap)
                            ? item.coin_info.format?.marketCap
                            : "";


                    const price_changes = {
                        "15min": {
                            percent: item?.price_changes?.["15min"]?.percent ?? null,
                            current: item?.price_changes?.["15min"]?.current ?? null,
                        },
                        "1h": {
                            percent: item?.price_changes?.["1h"]?.percent ?? null,
                            current: item?.price_changes?.["1h"]?.current ?? null,
                        },
                        "4h": {
                            percent: item?.price_changes?.["4h"]?.percent ?? null,
                            current: item?.price_changes?.["4h"]?.current ?? null,
                        },
                    }
                    const trend = item?.trend_analysis ?? {
                        "emoji": "‚ö†Ô∏è", "label": "Thi·∫øu d·ªØ li·ªáu"
                    };
                    const trendText = () => {
                        const p4h_percent = price_changes['4h']?.percent;

                        // Format s·ªë theo y√™u c·∫ßu: ph·∫ßn nguy√™n 3 ch·ªØ s·ªë, ph·∫ßn th·∫≠p ph√¢n 2 ch·ªØ s·ªë
                        const formatNumber = (num) => {
                            const [intPart, decPart = ''] = String(num).split('.');

                            // Pad ph·∫ßn nguy√™n v·ªõi s·ªë 0 b√™n tr√°i cho ƒë·ªß 3 ch·ªØ s·ªë
                            const paddedInt = intPart.padStart(3, '0');

                            // Pad ph·∫ßn th·∫≠p ph√¢n v·ªõi s·ªë 0 b√™n ph·∫£i cho ƒë·ªß 2 ch·ªØ s·ªë
                            const paddedDec = decPart.padEnd(2, '0');

                            // N·ªëi l·∫°i v√† remove d·∫•u ch·∫•m
                            return `${paddedInt}${paddedDec}`;
                        };

                        if (!p4h_percent) {
                            return `[${(trend?.trend ?? 0) + 2}.00000] ${trend.emoji}`;
                        }

                        if (p4h_percent >= 0) {
                            const p4h_percent_positive = parseFloat(p4h_percent);
                            const processedPositive = formatNumber(p4h_percent_positive);
                            return `[${(trend?.trend ?? 0) + 2}.${processedPositive}] ${trend.emoji}`;
                        }

                        const p4h_percent_negative = 100 + parseFloat(p4h_percent);
                        const processedNegative = formatNumber(p4h_percent_negative);
                        return `[${(trend?.trend ?? 0) + 2}.${processedNegative}] ${trend.emoji}`;
                    };
                    const tr = document.createElement("tr");
                    tr.innerHTML = ` 
                        <td class="text-nowrap">${item.instId || ''}</td>
                        <td class="text-nowrap">${item.timestamp ? formatTimestamp(item.timestamp) : ''}</td>
                        <td class="text-nowrap">${item.long_percent ?? ''}</td>
                        <td class="text-nowrap">${item.short_percent ?? ''}</td>
                        <td class="text-nowrap">${item.funding_rate_percent ?? ''}</td>
                        <td class="text-nowrap">${format_vol24h_usdt ?? ''}</td>
                        <td class="text-nowrap">${format_mktcap ?? ''}</td>
                        <td class="text-nowrap">${volCapRatio}</td>
                        
                        <td class="text-nowrap">${price_changes['15min']?.percent ?? '-'}</td>
                        <td class="text-nowrap">${price_changes['1h']?.percent ?? '-'}</td>
                        <td class="text-nowrap">${price_changes['4h']?.percent ?? '-'}</td>
                        <td class="text-nowrap" title="${trend.label}"><span style="display: none" >${trendText()}</span><span>${trend.emoji}</span></td>
                    `;
                    tbody.appendChild(tr);
                }

                window.dataTable = new DataTable("#ratioTable", {
                    searchable: true,
                    sortable: true,
                    perPage: 25,
                    sort: [[4, "desc"]], // Sort theo short_percent gi·∫£m d·∫ßn
                });

                initializeColumnToggle();

            } catch (err) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
                document.getElementById("ratioTable").style.display = "none";
                document.getElementById("noDataMessage").style.display = "block";
            }
        }

        loadData();
    </script>

</body>

</html>