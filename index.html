<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>OKX Ratio Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Vanilla-DataTables -->
    <link href="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.css" rel="stylesheet">

    <style>
        body {
            padding: 20px;
        }

        table.dataTable-table {
            color: white;
        }

        #noDataMessage {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">üìä OKX Long/Short Ratio (Live)</h2>

        <div id="noDataMessage" style="display: none;">
            ‚è≥ D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω, vui l√≤ng quay l·∫°i sau.
        </div>

        <table id="ratioTable" class="table table-dark table-bordered table-hover table-striped" style="display: none;">
            <thead>
                <tr>
                    <th>Instrument</th>
                    <th>Timestamp</th>
                    <th>Ratio</th>
                    <th>Long %</th>
                    <th>Short %</th>
                    <th>Funding Rate %</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.js"></script>
    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzFgl0O6kNSzEqdVzfWyzcK1ZQFZRtgmNm43GXbQpuFa6k1i4WMNLOW66x6mlgKGLx8/exec';

        function formatTimestamp(timestamp) {
            const d = new Date(Number(timestamp));
            const pad = n => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}-${pad(d.getMonth() + 1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        async function loadData() {
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();

                const table = document.getElementById("ratioTable");
                const message = document.getElementById("noDataMessage");
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";

                if (!data || data.length === 0) {
                    table.style.display = "none";
                    message.style.display = "block";
                    return;
                }

                message.style.display = "none";
                table.style.display = "table";

                for (const item of data) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.instId || ''}</td>
                        <td>${item.timestamp ? formatTimestamp(item.timestamp) : ''}</td>
                        <td>${item.ratio ?? ''}</td>
                        <td>${item.long_percent ?? ''}</td>
                        <td>${item.short_percent ?? ''}</td>
                        <td>${item.funding_rate_percent ?? ''}</td>
                    `;
                    tbody.appendChild(tr);
                }

                new DataTable("#ratioTable", {
                    searchable: true,
                    sortable: true,
                    perPage: 10,
                    sort: [[4, "desc"]] // Sort theo short_percent gi·∫£m d·∫ßn
                });

            } catch (err) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
                document.getElementById("ratioTable").style.display = "none";
                document.getElementById("noDataMessage").style.display = "block";
            }
        }

        loadData();
    </script>
</body>

</html>
