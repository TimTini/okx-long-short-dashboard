<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>OKX Ratio Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Vanilla-DataTables -->
    <link href="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.css"
        rel="stylesheet">

    <style>
        body {
            padding: 20px;
        }

        table.dataTable-table {
            color: white;
        }

        #noDataMessage {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">üìä OKX t·ªâ l·ªá Long/Short (C·∫≠p nh·∫≠t m·ªói 15 ph√∫t)</h2>


        <div id="noDataMessage" style="display: none;">
            ‚è≥ D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω, vui l√≤ng quay l·∫°i sau.
        </div>
        <div class="table-responsive">
            <table id="ratioTable" class="table table-dark table-bordered table-hover table-striped"
                style="display: none;">
                <thead>
                    <tr>
                        <th class="text-nowrap">C·∫∑p giao d·ªãch</th>
                        <th class="text-nowrap">Update At</th>
                        <th class="text-nowrap">Long %</th>
                        <th class="text-nowrap">Short %</th>
                        <th class="text-nowrap">Funding %</th>
                        <th class="text-nowrap">Vol 24h</th>
                        <th class="text-nowrap">Cap</th>
                        <th class="text-nowrap">Vol/Cap %</th>
                        <th class="text-nowrap">15m %</th>
                        <th class="text-nowrap">1h %</th>
                        <th class="text-nowrap">4h %</th>
                        <th class="text-nowrap">Xu H∆∞·ªõng</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.js"></script>
    <script>
        const baseUrl = 'https://tcn.io.vn';
        const apiUrl = baseUrl + '/api/instrument_ratios';

        function formatTimestamp(timestamp) {
            const d = new Date(timestamp);

            const pad = n => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}-${pad(d.getMonth() + 1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        async function loadData() {
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                const instrument_ratios = data.data;

                const table = document.getElementById("ratioTable");
                const message = document.getElementById("noDataMessage");
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";

                if (!instrument_ratios || instrument_ratios.length === 0) {
                    table.style.display = "none";
                    message.style.display = "block";
                    return;
                }

                message.style.display = "none";
                table.style.display = "table";

                for (const item of instrument_ratios) {

                    // Retrieve the 24-hour trade volume in USDT
                    const vol24_usdt = item?.market_future ? item.market_future?.turnOver24h ?? 0.0 : 0.0;

                    // Retrieve the market capitalization from either market_spot or coin_info
                    const cap = (item?.market_spot && item.market_spot?.marketCap)
                        ? item.market_spot?.marketCap
                        : (item?.coin_info && item.coin_info?.marketCap)
                            ? item.coin_info?.marketCap
                            : 0.0;

                    // Calculate the volume-to-capitalization ratio as a percentage
                    const volCapRatio = (vol24_usdt && cap && cap > 0)
                        ? ((vol24_usdt / cap) * 100).toFixed(2)
                        : "0.0";

                    // Format the 24-hour trade volume in USDT for display
                    const format_vol24h_usdt = item?.market_future
                        ? item.market_future.format?.turnOver24h ?? ""
                        : "";

                    // Format the market capitalization for display
                    const format_mktcap = (item?.market_spot && item.market_spot.format?.marketCap)
                        ? item.market_spot.format?.marketCap
                        : (item?.coin_info && item.coin_info.format?.marketCap)
                            ? item.coin_info.format?.marketCap
                            : "";


                    const price_changes = {
                        "15min": {
                            percent: item?.price_changes?.["15min"]?.percent ?? null,
                            current: item?.price_changes?.["15min"]?.current ?? null,
                        },
                        "1h": {
                            percent: item?.price_changes?.["1h"]?.percent ?? null,
                            current: item?.price_changes?.["1h"]?.current ?? null,
                        },
                        "4h": {
                            percent: item?.price_changes?.["4h"]?.percent ?? null,
                            current: item?.price_changes?.["4h"]?.current ?? null,
                        },
                    }
                    const trend = item?.trend_analysis ?? {
                        "emoji": "‚ö†Ô∏è", "label": "Thi·∫øu d·ªØ li·ªáu"
                    };

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="text-nowrap">${item.instId || ''}</td>
                        <td class="text-nowrap">${item.timestamp ? formatTimestamp(item.timestamp) : ''}</td>
                        <td class="text-nowrap">${item.long_percent ?? ''}</td>
                        <td class="text-nowrap">${item.short_percent ?? ''}</td>
                        <td class="text-nowrap">${item.funding_rate_percent ?? ''}</td>
                        <td class="text-nowrap">${format_vol24h_usdt ?? ''}</td>
                        <td class="text-nowrap">${format_mktcap ?? ''}</td>
                        <td class="text-nowrap">${volCapRatio}</td>
                        
                        <td class="text-nowrap">${price_changes['15min']?.percent ?? '-'}</td>
                        <td class="text-nowrap">${price_changes['1h']?.percent ?? '-'}</td>
                        <td class="text-nowrap">${price_changes['4h']?.percent ?? '-'}</td>
                        <td class="text-nowrap" title="${trend.label}">[${(trend?.trend ?? 0) + 2}] ${trend.emoji} ${trend.label}</td>
         
                    `;
                    tbody.appendChild(tr);
                }

                new DataTable("#ratioTable", {
                    searchable: true,
                    sortable: true,
                    perPage: 25,
                    sort: [[4, "desc"]], // Sort theo short_percent gi·∫£m d·∫ßn
                });

            } catch (err) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
                document.getElementById("ratioTable").style.display = "none";
                document.getElementById("noDataMessage").style.display = "block";
            }
        }

        loadData();
    </script>
</body>

</html>